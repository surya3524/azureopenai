<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Oncall Buddy</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      background: #f4f6fb;
      color: #222;
    }
    .header {
      background: #0052cc;
      color: #fff;
      padding: 18px 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 18px;
    }
    .header-title {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 1px;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .checkbox-container-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .checkbox-container-header input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: #fff;
    }
    .checkbox-container-header label {
      font-size: 14px;
      font-weight: 400;
      cursor: pointer;
      user-select: none;
      color: #fff;
      margin: 0;
    }
    .container {
      max-width: 700px;
      margin: 32px auto 0 auto;
      padding: 0 24px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      padding: 24px;
      margin-bottom: 24px;
      overflow-wrap: break-word;
      word-wrap: break-word;
      word-break: break-word;
    }
    .row {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }
    .settings-row {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      align-items: center;
    }
    .settings-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .settings-group label {
      font-size: 13px;
      color: #666;
      font-weight: 500;
    }
    .settings-group input[type="number"] {
      width: 100%;
      background: #f7f9fc;
      color: #222;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 14px;
    }
    textarea {
      width: 100%;
      min-height: 100px;
      resize: vertical;
      background: #f7f9fc;
      color: #222;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 12px;
      font-size: 15px;
      margin-bottom: 8px;
    }
    input, select {
      background: #f7f9fc;
      color: #222;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 10px;
      font-size: 15px;
    }
    button {
      background: #0052cc;
      color: #fff;
      border: 0;
      border-radius: 8px;
      padding: 12px 22px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
      transition: background 0.2s;
    }
    button:disabled {
      background: #b3c2e0;
      cursor: not-allowed;
    }
    .msg {
      padding: 14px 0;
      border-bottom: 1px solid #e5e7eb;
      overflow-wrap: break-word;
      word-wrap: break-word;
    }
    .msg.redacted-msg {
      display: none;
    }
    .msg.redacted-msg.visible {
      display: block;
    }
    .role {
      font-size: 13px;
      color: #0052cc;
      margin-bottom: 6px;
      font-weight: 500;
    }
    .content {
      white-space: pre-wrap;
      font-size: 15px;
      overflow-wrap: break-word;
      word-wrap: break-word;
      word-break: break-word;
      max-width: 100%;
    }
    .content.user-query {
      background: #e3f2fd;
      padding: 12px;
      border-radius: 8px;
      border-left: 4px solid #2196f3;
      color: #0d47a1;
    }
    .content.ai-response {
      background: #f1f8e9;
      padding: 12px;
      border-radius: 8px;
      border-left: 4px solid #689f38;
      color: #33691e;
    }
    .content.redacted {
      background: #fff3e0;
      padding: 12px;
      border-radius: 8px;
      border-left: 4px solid #ff9800;
      color: #e65100;
      font-size: 14px;
    }
    /* Redacted content styling */
    .redacted {
      background: #ffebee;
      color: #c62828;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      font-weight: 600;
      border: 1px solid #ef5350;
    }
    .content pre {
      white-space: pre-wrap;
      overflow-wrap: break-word;
      word-wrap: break-word;
      word-break: break-word;
      overflow-x: auto;
      background: #f5f5f5;
      padding: 12px;
      border-radius: 6px;
      max-width: 100%;
    }
    .content code {
      white-space: pre-wrap;
      overflow-wrap: break-word;
      word-wrap: break-word;
      word-break: break-word;
    }
    .content p {
      margin: 0 0 12px 0;
      overflow-wrap: break-word;
      word-wrap: break-word;
      word-break: break-word;
    }
    .error {
      color: #d7263d;
    }
    .tip {
      font-size: 13px;
      color: #6b7280;
    }
    .email-status {
      font-size: 14px;
      margin-top: 8px;
    }
    .version {
      font-size: 13px;
      color: #e0e7ff;
      font-weight: 400;
      opacity: 0.8;
    }
    /* Loading spinner styles */
    .spinner-container {
      display: none;
      padding: 20px;
      text-align: center;
    }
    .spinner-container.active {
      display: block;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0052cc;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .spinner-text {
      color: #0052cc;
      font-size: 14px;
      font-weight: 500;
    }
    @media (max-width: 600px) {
      .container { padding: 0 8px; }
      .card { padding: 12px; }
      .header {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
      }
      .header-right {
        width: 100%;
        justify-content: space-between;
      }
      .settings-row {
        flex-direction: column;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <span class="header-title">AI Oncall Buddy</span>
      <span id="appVersion" class="version"></span>
    </div>
    <div class="header-right">
      <div class="checkbox-container-header">
        <input type="checkbox" id="showFullLog" />
        <label for="showFullLog">Show Full Log</label>
      </div>
      <a href="DebugInfo.html" target="_blank" style="color:#fff; font-size:15px; text-decoration:underline;">OpenAI Debug Info</a>
    </div>
  </div>
  <div class="container">
    <div class="card">
      <label for="prompt" style="display:block;margin-bottom:4px;">Enter a <b>BMC job run</b>.</label>
      <textarea id="prompt" placeholder="Enter a BMC job run..."></textarea>
      
      <!-- AI Settings -->
      <div class="settings-row">
        <div class="settings-group">
          <label for="temperature">Temperature (0-2)</label>
          <input type="number" id="temperature" min="0" max="2" step="0.1" value="0" />
        </div>
        <div class="settings-group">
          <label for="maxTokens">Max Output Tokens</label>
          <input type="number" id="maxTokens" min="100" max="128000" step="100" value="6000" />
        </div>
      </div>
      
      <div class="row" style="align-items:center; justify-content:flex-end;">
        <div>
          <button id="send">Send</button>
        </div>
      </div>
    </div>
    
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="spinner-container">
      <div class="spinner"></div>
      <div class="spinner-text">Analyzing your request...</div>
    </div>
    
    <div class="card" id="output" style="margin-top:0;"></div>
    <div class="card">
      <h3 style="margin-top:0;">Send Email</h3>
      <div class="row">
        <input id="emailTo" type="email" placeholder="Recipient email" style="flex:1;" />
        <input id="emailSubject" placeholder="Subject" style="flex:2;" />
      </div>
      <textarea id="emailBody" placeholder="Email body..."></textarea>
      <div class="row" style="align-items:center; justify-content:flex-end;">
        <div>
          <button id="sendEmail">Send Email</button>
        </div>
      </div>
      <div id="emailStatus" class="email-status"></div>
    </div>
  </div>
  <script>
    const sendBtn = document.getElementById('send');
    const promptEl = document.getElementById('prompt');
    const temperatureEl = document.getElementById('temperature');
    const maxTokensEl = document.getElementById('maxTokens');
    const out = document.getElementById('output');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const showFullLogCheckbox = document.getElementById('showFullLog');

    function highlightRedactions(text) {
      // Highlight all redacted placeholders
      const redactionPatterns = [
        /\[REDACTED_EMAIL\]/g,
        /\[REDACTED_PATH\]/g,
        /\[REDACTED_IP\]/g,
        /\[REDACTED_IPv6\]/g,
        /\[REDACTED_GUID\]/g,
        /\[TIMESTAMP\]/g,
        /\[MEMADDR\]/g,
        /\[REDACTED_CC\]/g,
        /\[REDACTED_SSN\]/g,
        /\[REDACTED_PHONE\]/g,
        /\[REDACTED_USER\]/g,
        /\[REDACTED_JWT\]/g,
        /\[REDACTED_AWS_KEY\]/g,
        /\[REDACTED_PRIVATE_KEY\]/g,
        /\[REDACTED_NAME\]/g,
        /\[REDACTED\]/g
      ];
      
      let highlighted = text;
      redactionPatterns.forEach(pattern => {
        highlighted = highlighted.replace(pattern, (match) => {
          return `<span class="redacted">${match}</span>`;
        });
      });
      
      return highlighted;
    }

    function addMessage(role, text, isError=false, messageType='', isRedacted=false) {
      const d = document.createElement('div');
      d.className = 'msg';
      
      // Add redacted-msg class if this is a redacted message
      if (isRedacted) {
        d.classList.add('redacted-msg');
        // Check if checkbox is currently checked
        if (showFullLogCheckbox.checked) {
          d.classList.add('visible');
        }
      }
      
      const r = document.createElement('div');
      r.className = 'role';
      r.textContent = role;
      const c = document.createElement('div');
      let contentClass = 'content';
      if (messageType === 'user') {
        contentClass += ' user-query';
      } else if (messageType === 'ai') {
        contentClass += ' ai-response';
      } else if (messageType === 'redacted') {
        contentClass += ' redacted';
      }
      if (isError) {
        contentClass += ' error';
      }
      c.className = contentClass;
      
      // Parse markdown and then highlight redactions
      let parsedContent = marked.parse(text || '');
      
      // Apply redaction highlighting for user queries and redacted messages
      if (messageType === 'user' || messageType === 'redacted') {
        parsedContent = highlightRedactions(parsedContent);
      }
      
      c.innerHTML = parsedContent;
      d.appendChild(r);
      d.appendChild(c);
      out.prepend(d);
    }

    function showSpinner() {
      loadingSpinner.classList.add('active');
    }

    function hideSpinner() {
      loadingSpinner.classList.remove('active');
    }

    // Toggle visibility of redacted messages when checkbox changes
    showFullLogCheckbox.addEventListener('change', function() {
      const redactedMessages = document.querySelectorAll('.redacted-msg');
      redactedMessages.forEach(msg => {
        if (this.checked) {
          msg.classList.add('visible');
        } else {
          msg.classList.remove('visible');
        }
      });
    });

    async function send() {
      const temperature = parseFloat(temperatureEl.value) || 0;
      const maxTokens = parseInt(maxTokensEl.value) || 6000;
      
      const body = {
        system: null,
        prompt: promptEl.value || '',
        deployment: null,
        temperature: temperature,
        maxTokens: maxTokens
      };
      if (!body.prompt.trim()) return;

      sendBtn.disabled = true;
      showSpinner();
      
      // Show original user input with settings info
      const settingsInfo = `\n\n_Settings: Temperature=${temperature}, MaxTokens=${maxTokens}_`;
      addMessage('BMC job log (Your Input)', body.prompt + settingsInfo, false, 'user', false);
      promptEl.value = '';

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || res.statusText);
        }
        const data = await res.json();
        
        console.log('API Response:', data); // Debug log
        console.log('Was Redacted:', data.wasRedacted); // Debug log
        console.log('Normalized Prompt:', data.normalizedPrompt); // Debug log
        
        // If PII was redacted, show what was sent to the LLM (hidden by default)
        if (data.wasRedacted === true && data.normalizedPrompt) {
          console.log('Adding redacted message...'); // Debug log
          addMessage('⚠️ Redacted Query Sent to LLM', data.normalizedPrompt, false, 'redacted', true);
        } else {
          console.log('No redaction needed or data missing'); // Debug log
        }
        
        addMessage('On Call AI Buddy Response', data.text || '(no text)', false, 'ai', false);
      } catch (err) {
        console.error('Error:', err); // Debug log
        addMessage('Error', String(err), true, '', false);
      } finally {
        hideSpinner();
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener('click', send);
    promptEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
        send();
      }
    });

    // Email functionality
    const sendEmailBtn = document.getElementById('sendEmail');
    const emailTo = document.getElementById('emailTo');
    const emailSubject = document.getElementById('emailSubject');
    const emailBody = document.getElementById('emailBody');
    const emailStatus = document.getElementById('emailStatus');

    sendEmailBtn.addEventListener('click', async () => {
      emailStatus.textContent = '';
      sendEmailBtn.disabled = true;
      try {
        const res = await fetch('/api/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            to: emailTo.value,
            subject: emailSubject.value,
            body: emailBody.value
          })
        });
        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || res.statusText);
        }
        emailStatus.style.color = '#0052cc';
        emailStatus.textContent = 'Email sent!';
        emailTo.value = '';
        emailSubject.value = '';
        emailBody.value = '';
      } catch (err) {
        emailStatus.style.color = '#d7263d';
        emailStatus.textContent = 'Error: ' + err;
      } finally {
        sendEmailBtn.disabled = false;
      }
    });

    // Show app version in header
    async function showVersion() {
      try {
        const res = await fetch('/api/health');
        if (!res.ok) return;
        const data = await res.json();
        if (data.version) {
          document.getElementById('appVersion').textContent = `v${data.version}`;
        }
      } catch {}
    }
    showVersion();
  </script>
</body>
</html>
