<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI On Call Buddy - ServiceNow Simulator</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      background: #f4f5f7;
      color: #293e40;
    }
    .header {
      background: linear-gradient(135deg, #1f4788 0%, #2c5f8d 100%);
      color: #fff;
      padding: 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: relative;
    }
    .header-top {
      background: #081f3d;
      padding: 8px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }
    .header-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .snow-icon {
      width: 24px;
      height: 24px;
      background: #fff;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #081f3d;
      font-size: 14px;
    }
    .header-main {
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header-left {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    .header-title {
      font-size: 24px;
      font-weight: 400;
      letter-spacing: 0.5px;
    }
    .header-subtitle {
      font-size: 13px;
      opacity: 0.9;
      font-weight: 300;
    }
    .header-right {
      position: absolute;
      right: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .checkbox-container-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      transition: background 0.2s;
    }
    .checkbox-container-header:hover {
      background: rgba(255, 255, 255, 0.25);
    }
    .checkbox-container-header input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: #81b5e0;
    }
    .checkbox-container-header label {
      font-size: 13px;
      font-weight: 400;
      cursor: pointer;
      user-select: none;
      color: #fff;
      margin: 0;
    }
    .debug-link {
      color: #81b5e0;
      font-size: 13px;
      text-decoration: none;
      padding: 6px 12px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .debug-link:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    .container {
      max-width: 900px;
      margin: 32px auto 0 auto;
      padding: 0 24px;
    }
    .card {
      background: #fff;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      padding: 24px;
      margin-bottom: 20px;
      border: 1px solid #dfe3e6;
    }
    .card-header {
      font-size: 16px;
      font-weight: 500;
      color: #293e40;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #2c5f8d;
    }
    .row {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }
    .settings-row {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      align-items: flex-start;
    }
    .settings-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .settings-group label {
      font-size: 12px;
      color: #6b7780;
      font-weight: 500;
      white-space: nowrap;
    }
    .settings-group input[type="number"] {
      width: 100%;
      background: #fff;
      color: #293e40;
      border: 1px solid #c5d0de;
      border-radius: 3px;
      padding: 8px 10px;
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }
    .settings-group input[type="number"]:focus {
      outline: none;
      border-color: #2c5f8d;
      box-shadow: 0 0 0 2px rgba(44, 95, 141, 0.1);
    }
    textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      background: #fff;
      color: #293e40;
      border: 1px solid #c5d0de;
      border-radius: 3px;
      padding: 12px;
      font-size: 14px;
      margin-bottom: 8px;
      box-sizing: border-box;
      font-family: 'Segoe UI', Arial, sans-serif;
      transition: border-color 0.2s;
    }
    textarea:focus {
      outline: none;
      border-color: #2c5f8d;
      box-shadow: 0 0 0 2px rgba(44, 95, 141, 0.1);
    }
    input, select {
      background: #fff;
      color: #293e40;
      border: 1px solid #c5d0de;
      border-radius: 3px;
      padding: 10px;
      font-size: 14px;
    }
    button {
      background: #2c5f8d;
      color: #fff;
      border: 0;
      border-radius: 3px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    button:hover {
      background: #1f4788;
    }
    button:disabled {
      background: #a8b5c2;
      cursor: not-allowed;
    }
    .msg {
      padding: 14px 0;
      border-bottom: 1px solid #e8ecef;
      overflow-wrap: break-word;
      word-wrap: break-word;
    }
    .msg.redacted-msg {
      display: none;
    }
    .msg.redacted-msg.visible {
      display: block;
    }
    .role {
      font-size: 12px;
      color: #2c5f8d;
      margin-bottom: 8px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .content {
      white-space: pre-wrap;
      font-size: 14px;
      overflow-wrap: break-word;
      word-wrap: break-word;
      word-break: break-word;
      max-width: 100%;
      line-height: 1.6;
    }
    .content.user-query {
      background: #e8f4fd;
      padding: 12px;
      border-radius: 3px;
      border-left: 4px solid #2c5f8d;
      color: #293e40;
    }
    .content.ai-response {
      background: #e6f5e8;
      padding: 12px;
      border-radius: 3px;
      border-left: 4px solid #46a546;
      color: #293e40;
    }
    .content.redacted {
      background: #fff4e6;
      padding: 12px;
      border-radius: 3px;
      border-left: 4px solid #ff9800;
      color: #663c00;
      font-size: 13px;
    }
    /* Redacted content styling */
    .redacted {
      background: #ffe9e9;
      color: #c62828;
      padding: 2px 6px;
      border-radius: 2px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid #ffcdd2;
    }
    .content pre {
      white-space: pre-wrap;
      overflow-wrap: break-word;
      word-wrap: break-word;
      word-break: break-word;
      overflow-x: auto;
      background: #f8f9fa;
      padding: 12px;
      border-radius: 3px;
      max-width: 100%;
      border: 1px solid #dfe3e6;
    }
    .content code {
      white-space: pre-wrap;
      overflow-wrap: break-word;
      word-wrap: break-word;
      word-break: break-word;
    }
    .content p {
      margin: 0 0 12px 0;
      overflow-wrap: break-word;
      word-wrap: break-word;
      word-break: break-word;
    }
    .error {
      color: #d7263d;
    }
    .tip {
      font-size: 12px;
      color: #6b7780;
    }
    .email-status {
      font-size: 13px;
      margin-top: 8px;
    }
    .version {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      font-weight: 400;
    }
    .spinner-container {
      display: none;
      padding: 20px;
      text-align: center;
    }
    .spinner-container.active {
      display: block;
    }
    .spinner {
      border: 4px solid #e8ecef;
      border-top: 4px solid #2c5f8d;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .spinner-text {
      color: #2c5f8d;
      font-size: 14px;
      font-weight: 500;
    }
    @media (max-width: 600px) {
      .container { padding: 0 8px; }
      .card { padding: 16px; }
      .header-main {
        flex-direction: column;
        gap: 12px;
        align-items: center;
        position: relative;
      }
      .header-left {
        width: 100%;
        justify-content: center;
      }
      .header-right {
        position: static;
        width: 100%;
        justify-content: center;
      }
      .settings-row {
        flex-direction: column;
        gap: 12px;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="header">
    <div class="header-top">
      <div class="header-logo">
        <div class="snow-icon">SN</div>
        <span>ServiceNow Platform Simulator</span>
      </div>
      <span id="appVersion" class="version"></span>
    </div>
    <div class="header-main">
      <div class="header-left">
        <div style="text-align: center;">
          <div class="header-title">AI On Call Buddy</div>
          <div class="header-subtitle">ServiceNow Simulator</div>
        </div>
      </div>
      <div class="header-right">
        <div class="checkbox-container-header">
          <input type="checkbox" id="showFullLog" />
          <label for="showFullLog">Show Full Log</label>
        </div>
        <a href="DebugInfo.html" target="_blank" class="debug-link">Debug Info</a>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="card">
      <div class="card-header">BMC Job Analysis</div>
      <label for="prompt" style="display:block;margin-bottom:8px;font-size:13px;color:#6b7780;font-weight:500;">Enter BMC Job Log</label>
      <textarea id="prompt" placeholder="Paste your BMC job run logs here..."></textarea>
      
      <!-- AI Settings -->
      <div class="settings-row">
        <div class="settings-group">
          <label for="temperature">Temperature (0-2)</label>
          <input type="number" id="temperature" min="0" max="2" step="0.1" value="0" />
        </div>
        <div class="settings-group">
          <label for="maxTokens">Max Output Tokens</label>
          <input type="number" id="maxTokens" min="100" max="128000" step="100" value="6000" />
        </div>
      </div>
      
      <div class="row" style="align-items:center; justify-content:flex-end;">
        <div>
          <button id="send">Analyze</button>
        </div>
      </div>
    </div>
    
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="spinner-container">
      <div class="spinner"></div>
      <div class="spinner-text">Analyzing your request...</div>
    </div>
    
    <div class="card" id="output" style="margin-top:0;"></div>
    <div class="card">
      <div class="card-header">Send Email Notification</div>
      <div class="row">
        <input id="emailTo" type="email" placeholder="Recipient email" style="flex:1;" />
        <input id="emailSubject" placeholder="Subject" style="flex:2;" />
      </div>
      <textarea id="emailBody" placeholder="Email body..." style="min-height:80px;"></textarea>
      <div class="row" style="align-items:center; justify-content:flex-end;">
        <div>
          <button id="sendEmail">Send Email</button>
        </div>
      </div>
      <div id="emailStatus" class="email-status"></div>
    </div>
  </div>
  <script>
    const sendBtn = document.getElementById('send');
    const promptEl = document.getElementById('prompt');
    const temperatureEl = document.getElementById('temperature');
    const maxTokensEl = document.getElementById('maxTokens');
    const out = document.getElementById('output');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const showFullLogCheckbox = document.getElementById('showFullLog');

    function highlightRedactions(text) {
      // Highlight all redacted placeholders
      const redactionPatterns = [
        /\[REDACTED_EMAIL\]/g,
        /\[REDACTED_URL\]/g,
        /\[REDACTED_PATH\]/g,
        /\[REDACTED_IP\]/g,
        /\[REDACTED_IPv6\]/g,
        /\[REDACTED_GUID\]/g,
        /\[TIMESTAMP\]/g,
        /\[MEMADDR\]/g,
        /\[REDACTED_CC\]/g,
        /\[REDACTED_SSN\]/g,
        /\[REDACTED_PHONE\]/g,
        /\[REDACTED_USER\]/g,
        /\[REDACTED_JWT\]/g,
        /\[REDACTED_AWS_KEY\]/g,
        /\[REDACTED_PRIVATE_KEY\]/g,
        /\[REDACTED_NAME\]/g,
        /\[REDACTED\]/g
      ];
      
      let highlighted = text;
      redactionPatterns.forEach(pattern => {
        highlighted = highlighted.replace(pattern, (match) => {
          return `<span class="redacted">${match}</span>`;
        });
      });
      
      return highlighted;
    }

    function addMessage(role, text, isError=false, messageType='', isRedacted=false) {
      const d = document.createElement('div');
      d.className = 'msg';
      
      // Add redacted-msg class if this is a redacted message
      if (isRedacted) {
        d.classList.add('redacted-msg');
        // Check if checkbox is currently checked
        if (showFullLogCheckbox.checked) {
          d.classList.add('visible');
        }
      }
      
      const r = document.createElement('div');
      r.className = 'role';
      r.textContent = role;
      const c = document.createElement('div');
      let contentClass = 'content';
      if (messageType === 'user') {
        contentClass += ' user-query';
      } else if (messageType === 'ai') {
        contentClass += ' ai-response';
      } else if (messageType === 'redacted') {
        contentClass += ' redacted';
      }
      if (isError) {
        contentClass += ' error';
      }
      c.className = contentClass;
      
      // Parse markdown and then highlight redactions
      let parsedContent = marked.parse(text || '');
      
      // Apply redaction highlighting for user queries and redacted messages
      if (messageType === 'user' || messageType === 'redacted') {
        parsedContent = highlightRedactions(parsedContent);
      }
      
      c.innerHTML = parsedContent;
      d.appendChild(r);
      d.appendChild(c);
      out.prepend(d);
    }

    function showSpinner() {
      loadingSpinner.classList.add('active');
    }

    function hideSpinner() {
      loadingSpinner.classList.remove('active');
    }

    // Toggle visibility of redacted messages when checkbox changes
    showFullLogCheckbox.addEventListener('change', function() {
      const redactedMessages = document.querySelectorAll('.redacted-msg');
      redactedMessages.forEach(msg => {
        if (this.checked) {
          msg.classList.add('visible');
        } else {
          msg.classList.remove('visible');
        }
      });
    });

    async function send() {
      const temperature = parseFloat(temperatureEl.value) || 0;
      const maxTokens = parseInt(maxTokensEl.value) || 6000;
      
      const body = {
        system: null,
        prompt: promptEl.value || '',
        deployment: null,
        temperature: temperature,
        maxTokens: maxTokens
      };
      if (!body.prompt.trim()) return;

      sendBtn.disabled = true;
      showSpinner();
      
      // Show original user input with settings info
      const settingsInfo = `\n\n_Settings: Temperature=${temperature}, MaxTokens=${maxTokens}_`;
      addMessage('BMC job log (Your Input)', body.prompt + settingsInfo, false, 'user', false);
      promptEl.value = '';

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || res.statusText);
        }
        const data = await res.json();
        
        console.log('API Response:', data);
        console.log('Was Redacted:', data.wasRedacted);
        console.log('Normalized Prompt:', data.normalizedPrompt);
        
        // If PII was redacted, show what was sent to the LLM (hidden by default)
        if (data.wasRedacted === true && data.normalizedPrompt) {
          console.log('Adding redacted message...');
          addMessage('⚠️ Redacted Query Sent to LLM', data.normalizedPrompt, false, 'redacted', true);
        } else {
          console.log('No redaction needed or data missing');
        }
        
        addMessage('AI Analysis Results', data.text || '(no text)', false, 'ai', false);
      } catch (err) {
        console.error('Error:', err);
        addMessage('Error', String(err), true, '', false);
      } finally {
        hideSpinner();
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener('click', send);
    promptEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
        send();
      }
    });

    // Email functionality
    const sendEmailBtn = document.getElementById('sendEmail');
    const emailTo = document.getElementById('emailTo');
    const emailSubject = document.getElementById('emailSubject');
    const emailBody = document.getElementById('emailBody');
    const emailStatus = document.getElementById('emailStatus');

    sendEmailBtn.addEventListener('click', async () => {
      emailStatus.textContent = '';
      sendEmailBtn.disabled = true;
      try {
        const res = await fetch('/api/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            to: emailTo.value,
            subject: emailSubject.value,
            body: emailBody.value
          })
        });
        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || res.statusText);
        }
        emailStatus.style.color = '#46a546';
        emailStatus.textContent = 'Email sent successfully!';
        emailTo.value = '';
        emailSubject.value = '';
        emailBody.value = '';
      } catch (err) {
        emailStatus.style.color = '#d7263d';
        emailStatus.textContent = 'Error: ' + err;
      } finally {
        sendEmailBtn.disabled = false;
      }
    });

    // Show app version in header
    async function showVersion() {
      try {
        const res = await fetch('/api/health');
        if (!res.ok) return;
        const data = await res.json();
        if (data.version) {
          document.getElementById('appVersion').textContent = `v${data.version}`;
        }
      } catch {}
    }
    showVersion();
  </script>
</body>
</html>
